FROM node:20-alpine AS builder

WORKDIR /app

COPY package.json package-lock.json* ./
RUN npm ci

COPY . .

ARG ACT_SHOPIFY_STORE_ID
ARG ACT_SHOPIFY_SHOP_DOMAIN
ARG ACT_SHOPIFY_CLIENT_ID
ARG ACT_OAUTH_REDIRECT_URI
ARG ACT_OAUTH_REDIRECT_URI_PROD
ARG ACT_SHOPIFY_STOREFRONT_TOKEN
ARG ACT_SHOPIFY_API_VERSION
ARG ACT_APP_URL
ARG ACT_APP_URL_PROD
ARG ACT_BACKEND_URL
ARG ACT_BACKEND_URL_PROD

ENV ACT_SHOPIFY_STORE_ID=$ACT_SHOPIFY_STORE_ID
ENV ACT_SHOPIFY_SHOP_DOMAIN=$ACT_SHOPIFY_SHOP_DOMAIN
ENV ACT_SHOPIFY_CLIENT_ID=$ACT_SHOPIFY_CLIENT_ID
ENV ACT_OAUTH_REDIRECT_URI=$ACT_OAUTH_REDIRECT_URI
ENV ACT_OAUTH_REDIRECT_URI_PROD=$ACT_OAUTH_REDIRECT_URI_PROD
ENV ACT_SHOPIFY_STOREFRONT_TOKEN=$ACT_SHOPIFY_STOREFRONT_TOKEN
ENV ACT_SHOPIFY_API_VERSION=$ACT_SHOPIFY_API_VERSION
ENV ACT_APP_URL=$ACT_APP_URL
ENV ACT_APP_URL_PROD=$ACT_APP_URL_PROD
ENV ACT_BACKEND_URL=$ACT_BACKEND_URL
ENV ACT_BACKEND_URL_PROD=$ACT_BACKEND_URL_PROD

RUN npm run build

FROM nginx:alpine

RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
